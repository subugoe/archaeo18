<project name="Archaeo18 Test" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant" default="serve"
  xmlns:artifact="antlib:org.apache.maven.artifact.ant">
  <!--
Usage:
svn co https://develop.sub.uni-goettingen.de/repos/ent/archaeo18/branches/archaeo18
cd archaeo18
ant
-->
  <!-- Jetty settings -->
  <property name="jetty.port" value="8080"/>

  <!-- directory for the build system -->
  <property name="lib.dir" value="./lib"/>
  <property name="lib.target" value="./target"/>
  <property name="lib.build.dir" value="${lib.dir}/build"/>
  <property name="lib.jetty.dir" value="${lib.dir}/jetty"/>
  <property name="jetty.dir.tmp" value="./tmp"/>
  <!-- Ivy stuff -->
  <property name="ivy.install.version" value="2.2.0"/>
  <property name="ivy.jar.file" value="${lib.build.dir}/ivy-${ivy.install.version}.jar"/>
  <property name="ivy.download.url"
    value="http://repo1.maven.org/maven2/org/apache/ivy/ivy/${ivy.install.version}/ivy-${ivy.install.version}.jar"/>

  <!-- Maven stuff -->
  <property name="maven.install.version" value="2.1.3"/>
  <property name="maven.jar.file"
    value="${lib.build.dir}/maven-ant-tasks-${maven.install.version}.jar"/>
  <property name="maven.download.url"
    value="http://repo1.maven.org/maven2/org/apache/maven/maven-ant-tasks/${maven.install.version}/maven-ant-tasks-${maven.install.version}.jar"/>

  <!-- Servlet configuration -->
  <property name="servlet.archaeo18.webxml" value="./WEB-INF/web.xml"/>
  <property name="servlet.proxy.webxml" value="./testdata/proxy/WEB-INF/web.xml"/>

  <!-- Test data -->
  <property name="test.dir" value="./testdata"/>
  <property name="data.download.dir.indices" value="${test.dir}/indices"/>

  <!-- Patches -->
  <property name="patch.dir" value="${test.dir}/patches"/>

  <!-- eXist Backend -->
  <property name="exist.base.url" value="http://134.76.21.92:8080"/>
  <property name="exist.queries.url" value="${exist.base.url}/exist/rest/db/archaeo18/queries"/>
  <property name="exist.entities.url"
    value="${exist.queries.url}/experimental/listEntities.xq?format=xhtml&amp;facet="/>

  <!-- Test data for the indices  page and their local names -->
  <property name="exist.entities.persName.url" value="${exist.entities.url}persName"/>
  <property name="exist.entities.placeName.url" value="${exist.entities.url}tei:placeName"/>
  <property name="exist.entities.term.url" value="${exist.entities.url}tei:term"/>
  <property name="exist.entities.bibl.url" value="${exist.entities.url}tei:bibl"/>
  <!-- local names -->
  <property name="exist.entities.persName.local"
    value="${data.download.dir.indices}/listEntities.xq$facet=tei:persName&amp;format=xhtml"/>
  <property name="exist.entities.placeName.local"
    value="${data.download.dir.indices}/listEntities.xq$facet=tei:placeName&amp;format=xhtml"/>
  <property name="exist.entities.term.local"
    value="${data.download.dir.indices}/listEntities.xq$facet=tei:term&amp;format=xhtml"/>
  <property name="exist.entities.bibl.local"
    value="${data.download.dir.indices}/listEntities.xq$facet=tei:bibl&amp;format=xhtml"/>

  <!-- JavaScript Stuff -->
  <property name="lib.envjs.download.url" value="http://github.com/thatcher/env-js/zipball/1.2.13"/>
  <property name="lib.envjs.dir" value="${lib.dir}/envjs"/>
  <property name="lib.envjs.local" value="${lib.envjs.dir}/env-js-1.2.1.zip"/>

  <target name="init" depends="">
    <mkdir dir="${lib.dir}"/>
    <mkdir dir="${lib.build.dir}"/>
    <mkdir dir="${lib.jetty.dir}"/>
    <mkdir dir="${target.dir}"/>
  </target>

  <target name="envjs.download" unless="skip.download" depends="init">
    <get src="${lib.envjs.download.url}" dest="${lib.envjs.local}" usetimestamp="true"/>
    <unzip src="${lib.envjs.local}" dest="${lib.envjs.dir}"/>
  </target>

  <!-- Stolen from http://blogs.steeplesoft.com/2008/01/dependency-management-with-ant-and-ivy/ -->
  <!--
  <target name="ivy.download" unless="skip.download" depends="lib.build.dir.create">

    <echo message="installing ivy..."/>
    <get src="${ivy.download.url}" dest="${ivy.jar.file}" usetimestamp="true"/>
  </target>

  <target name="ivy.install" depends="ivy.download" description="">
    <path id="ivy.lib.path">
      <fileset dir="${lib.build.dir}" includes="*.jar"/>
    </path>
    <taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant"
      classpathref="ivy.lib.path"/>
  </target>

  <target name="jetty.download.ivy" depends="ivy.install, lib.jetty.dir.create">
    <ivy:resolve/>
    <ivy:retrieve sync="true" type="jar" pattern="${lib.jetty.dir}/[artifact]-[revision].[ext]"/>
  </target>
-->
  <target name="maven.download" unless="skip.download" depends="init">
    <echo message="Downloading and installing maven..."/>
    <get src="${maven.download.url}" dest="${maven.jar.file}" usetimestamp="true"/>
    <path id="maven.lib.path">
      <fileset dir="${lib.build.dir}" includes="*.jar"/>
    </path>
    <taskdef uri="antlib:org.apache.maven.artifact.ant"
      resource="org/apache/maven/artifact/ant/antlib.xml" classpathref="maven.lib.path"/>
  </target>

  <target name="jetty.download" depends="maven.download">
    <artifact:dependencies filesetId="jetty.local.classpath">
      <dependency groupId="org.mortbay.jetty" artifactId="jetty-ant" version="7.6.0.v20120127"/>
      <dependency groupId="org.tuckey" artifactId="urlrewritefilter" version="4.0.3"/>
    </artifact:dependencies>
    <copy todir="${lib.jetty.dir}">
      <fileset refid="jetty.local.classpath"/>
      <mapper type="flatten"/>
    </copy>
  </target>

  <target name="config.patch">
    <patch patchfile="${patch.dir}/indeces-local.patch"
      originalfile="./a18/lib/archaeo18/Archaeo18Properties.js"/>
  </target>

  <target name="jetty.install" depends="jetty.download">
    <path id="jetty.plugin.classpath">
      <fileset dir="${lib.jetty.dir}" includes="*.jar"/>
    </path>
    <taskdef classpathref="jetty.plugin.classpath" resource="tasks.properties"
      loaderref="jetty.loader"/>
    <typedef name="selectChannelConnector"
      classname="org.eclipse.jetty.server.nio.SelectChannelConnector"
      classpathref="jetty.plugin.classpath" loaderref="jetty.loader"/>
  </target>

  <target name="clean">
    <delete dir="${lib.dir}"/>
    <delete dir="${jetty.dir.tmp}"/>
  </target>

  <target name="jetty.start" depends="jetty.install">
    <!-- 
    See http://docs.codehaus.org/display/JETTY/Ant+Jetty+Plugin for configuration
    For newer Versions
    http://www.eclipse.org/jetty/documentation/current/jetty-ant.html
    -->
    <echo>starting Jetty...</echo>
    <jetty tempDirectory="${jetty.dir.tmp}">
      <connectors>
        <selectChannelConnector port="${jetty.port}"/>
      </connectors>
      <webapp webXmlFile="${servlet.archaeo18.webxml}" contextPath="/archaeo18" name="archaeo18"
        warfile="."/>
      <webapp webXmlFile="${servlet.proxy.webxml}" contextPath="/" name="proxy"
        warfile="${test.dir}/proxy"/>
    </jetty>
  </target>

  <target name="data.download">
    <get src="${exist.entities.persName.url}" dest="${exist.entities.persName.local}"/>
    <get src="${exist.entities.placeName.url}" dest="${exist.entities.placeName.local}"/>
    <get src="${exist.entities.term.url}" dest="${exist.entities.term.local}"/>
    <get src="${exist.entities.bibl.url}" dest="${exist.entities.bibl.local}"/>
  </target>

  <target name="war.dependencies" depends="maven.download, init">
    <property name="war.dir" value="${lib.target}/webapp"></property>
    <property name="war.dir.lib" value="${war.dir}/WEB-INF/lib"></property>
    <mkdir dir=""/>
    <artifact:remoteRepository id="caucho" url="http://caucho.com/m2"/>
    <artifact:dependencies filesetId="war.classpath">
      <dependency groupId="org.tuckey" artifactId="urlrewritefilter" version="4.0.3"/>
      <dependency groupId="com.caucho" artifactId="resin-quercus" version="3.2.0"/>
    </artifact:dependencies>
    <copy todir="${war.dir.lib}">
      <fileset refid="war.classpath"/>
      <mapper type="flatten"/>
    </copy>
  </target>


  <target name="war" depends="war.dependencies"/>

  <target name="serve" depends="jetty.start"/>

</project>
