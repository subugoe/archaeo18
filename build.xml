<project name="Archaeo18 Test" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant" default="serve">
  <!--
Usage:
svn co https://develop.sub.uni-goettingen.de/repos/ent/archaeo18/branches/archaeo18
cd archaeo18
ant
-->
  <!-- directory for the build system -->
  <property name="lib.build.dir" value="./lib/build"/>
  <property name="lib.jetty.dir" value="./lib/jetty"/>
  <property name="jetty.dir.tmp" value="./tmp"/>
  <!-- Ivy version -->
  <property name="ivy.install.version" value="2.2.0"/>
  <property name="ivy.jar.file" value="${lib.build.dir}/ivy-${ivy.install.version}.jar"/>

  <!-- Servlet configuration -->
  <property name="servlet.archaeo18.webxml" value="./WEB-INF/web.xml"/>
  <property name="servlet.proxy.webxml" value="./testdata/proxy/WEB-INF/web.xml"/>

  <!-- Test data -->
  <property name="test.dir" value="./testdata"/>
  <property name="data.download.dir.indices" value="${test.dir}/indices"/>

  <!-- Patches -->
  <property name="patch.dir" value="${test.dir}/patches"/>

  <!-- eXist Backend -->
  <property name="exist.base.url" value="http://134.76.21.92:8080"/>
  <property name="exist.queries.url" value="${exist.base.url}/exist/rest/db/archaeo18/queries"/>
  <property name="exist.entities.url"
    value="${exist.queries.url}/experimental/listEntities.xq?format=xhtml&amp;facet="/>

  <!-- Test data for the indices  page and their local names -->
  <property name="exist.entities.persName.url" value="${exist.entities.url}persName"/>
  <property name="exist.entities.placeName.url" value="${exist.entities.url}tei:placeName"/>
  <property name="exist.entities.term.url" value="${exist.entities.url}tei:term"/>
  <property name="exist.entities.bibl.url" value="${exist.entities.url}tei:bibl"/>
  <!-- local names -->
  <property name="exist.entities.persName.local"
    value="${data.download.dir.indices}/listEntities.xq$facet=tei:persName&amp;format=xhtml"/>
  <property name="exist.entities.placeName.local"
    value="${data.download.dir.indices}/listEntities.xq$facet=tei:placeName&amp;format=xhtml"/>
  <property name="exist.entities.term.local"
    value="${data.download.dir.indices}/listEntities.xq$facet=tei:term&amp;format=xhtml"/>
  <property name="exist.entities.bibl.local"
    value="${data.download.dir.indices}/listEntities.xq$facet=tei:bibl&amp;format=xhtml"/>

  <target name="init" depends="ivy.download"/>

  <target name="lib.build.dir.create" depends="lib.build.dir.check" unless="lib.build.dir.exists">
    <mkdir dir="${lib.build.dir}"/>
    <echo>${lib.build.dir} created"</echo>
  </target>

  <target name="lib.build.dir.check">
    <condition property="lib.build.dir.exists">
      <available file="${lib.build.dir}" type="dir"/>
    </condition>
  </target>

  <target name="lib.jetty.dir.create" depends="lib.jetty.dir.check" unless="lib.jetty.dir.exists">
    <mkdir dir="${lib.jetty.dir}"/>
    <echo>${lib.jetty.dir} created"</echo>
  </target>

  <target name="lib.jetty.dir.check">
    <condition property="lib.jetty.dir.exists">
      <available file="${lib.jetty.dir}" type="dir"/>
    </condition>
  </target>

  <target name="jetty.dir.tmp.create" depends="jetty.dir.tmp.check" unless="jetty.dir.tmp.exists">
    <mkdir dir="${jetty.dir.tmp}"/>
    <echo>${jetty.dir.tmp} created"</echo>
  </target>

  <target name="jetty.dir.tmp.check">
    <condition property="jetty.dir.tmp.exists">
      <available file="${jetty.dir.tmp}" type="dir"/>
    </condition>
  </target>

  <!-- Stolen from http://blogs.steeplesoft.com/2008/01/dependency-management-with-ant-and-ivy/ -->
  <target name="ivy.download" unless="skip.download" depends="lib.build.dir.create">
    <!-- download Ivy from web site so that it can be used even without any special installation -->
    <echo message="installing ivy..."/>
    <get
      src="http://repo1.maven.org/maven2/org/apache/ivy/ivy/${ivy.install.version}/ivy-${ivy.install.version}.jar"
      dest="${ivy.jar.file}" usetimestamp="true"/>
  </target>

  <target name="ivy.install" depends="ivy.download" description="--> install ivy">
    <path id="ivy.lib.path">
      <fileset dir="${lib.build.dir}" includes="*.jar"/>
    </path>
    <taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant"
      classpathref="ivy.lib.path"/>
  </target>

  <target name="jetty.download" depends="ivy.install, lib.jetty.dir.create">
    <ivy:resolve/>
    <!--
                        <ivy:cachepath pathid="jetty.classpath"/>
                        -->
    <ivy:retrieve sync="true" type="jar" pattern="${lib.jetty.dir}/[artifact]-[revision].[ext]"/>
  </target>

  <target name="config.patch">
    <patch patchfile="${patch.dir}/indeces-local.patch"
      originalfile="./a18/lib/archaeo18/Archaeo18Properties.js"/>
  </target>

  <target name="jetty.install" depends="jetty.download">
    <path id="jetty.plugin.classpath">
      <fileset dir="${lib.jetty.dir}" includes="*.jar"/>
    </path>
    <taskdef classpathref="jetty.plugin.classpath" resource="tasks.properties"
      loaderref="jetty.loader"/>
  </target>

  <target name="clean">
    <delete dir="${lib.build.dir}"/>
    <delete dir="${jetty.dir.tmp}"/>
  </target>

  <target name="jetty.start" depends="jetty.install, jetty.dir.tmp.create">
    <jetty tempDirectory="${jetty.dir.tmp}">
      <webapp webXmlFile="${servlet.archaeo18.webxml}" contextPath="/archaeo18" name="archaeo18"
        warfile="."/>
      <webapp webXmlFile="${servlet.proxy.webxml}" contextPath="/" name="proxy" warfile="${test.dir}/proxy"/>
    </jetty>
  </target>

  <target name="data.download">
      <get src="${exist.entities.persName.url}" dest="${exist.entities.persName.local}"/>
      <get src="${exist.entities.placeName.url}" dest="${exist.entities.placeName.local}"/>
      <get src="${exist.entities.term.url}" dest="${exist.entities.term.local}"/>
      <get src="${exist.entities.bibl.url}" dest="${exist.entities.bibl.local}"/>
  </target>

  <target name="serve" depends="jetty.start"/>

</project>
